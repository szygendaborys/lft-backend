# Looking For Team

An application which helps to find teammates for games.

Useful links: (generated by [this page](https://www.tablesgenerator.com/markdown_tables))

|   | Name             | Production URL |
|---|------------------|----------------|
| 1 | Trello           |                |
| 2 | Sentry           |                |
| 3 | Railways Service |                |
| 4 | ClickUp space    |                |
| 5 | Roadmap          |                |

## Makefile

In order to run integration tests write:

`make test-db`

`make test-int`

In order to run app write:

`make compose-up` or `docker-compose up -d`

## Wiping data in DB

In order to drop all data write:

`make wipe-data`;

## Seeding data into DB

TODO: Probably we can use typeorm seeds

## Migrations 

- The state of the database should be rebuilt from scratch using only typeorm migrations,
- Currently, we generate migrations using the command `npm run typeorm -- migrations:generate migrationName -d datasource.ts`
- If in the future we'd like to add a custom migration, we can use the command `npm run typeorm -- migrations:create migrationName -d datasource.ts` (not recommended)

## Security

- All routes are by default protected by JwtAuth. If you want to change a single route you need to add a decorator `@Public()`;
- All routes can be checked with a `@Role()` decorator - The higher level of permissions the more user can do

## Notification service

For the invocation of the notification you need to call a `NotificationMedium` which is responsible to propagate further all the notification logic.

### NotificationMedium

In the `NotificationModule` you can attach different types of notifications to it in order to handle it in a different way. Notification consists of a specific `NotificationType` which requires some data payload, user and already knows which handlers it has to invoke in the future to finish the Notification processing.

Config for `NotificationMedium` looks like this:

```
const  config: ReadonlyMap<
	NotificationTypes,
	NotificationHandler[]
> = new  Map<NotificationTypes, NotificationHandler[]>([
	[NotificationTypes.resetPasswordConfirmationLink, [mailHandler]],
	// ...Here you add different notificatino types, all notification types should be placed.
	// Otherwise an error would be thrown
]);
```

### How to trigger a notification?

You can trigger a notification this way:

```
await  this.notificationMedium.sendNotification({
	user,
	type:  NotificationTypes.resetPasswordConfirmationLink,
	data: {
		verificationCode,
	},
});
```

## WebSockets

Websocket gateways serve similar role as REST controllers. They are protected by guards.

I.e. `chat.gateway.ts` serves as a "controller" for any incoming chat-related messages.

We use websockets to:
- Send new messages to room subscribers

In the future we might want to publish some custom events. i.e. to automatically add new rooms into the dashboard.

## Testing

- Remember to always mirror app changes to test app module.

### Integration tests checks

While creating an integration test - below you have a sample test cases to cover

- Add 404 tests
- 403 - Add check for roles
- Add 401 tests (multiple cases) with and without permissions
- Add 201
- Add 200

## Configs

- GameConfig - contains the config of all games (game can be active or not)

## Sentry

Sentry is preconfigured to report any ongoing problems with the backend.
In the future releases we would export source maps to let Sentry know what potential release could break the appliacation.

## Deployment

We use *Railway* to deploy our backend. Currently, the whole infrastructure is automated.

- `dev` branch serves as a development branch
- Release Candidate is being created: `Release Candidate Day/Month/Year (if more than one, add number here)` dev -> master
- After successful pipelines, merge `dev` into `master` and manually trigger a pipeline `Deploy to production`
- Don't forget to add new release in the Github releases.
